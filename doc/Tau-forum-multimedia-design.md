## Forum multimedia design

由于论坛业务需求可以使用文字、图片、音频、视频媒体表现形式，因此根据对多媒体的调研[Multimedia-compression-research](./Multimedia-compression-research.md)的结果和讨论，同时结合IPFS作为存储，文件Hash上链的核心技术方案。多媒体相关的实现方案如下：

### 图片

Android中常见的Image的类型有png、jpeg、jpg、gif、bmp、webp等。<br/>
用户选择图片媒体逻辑步骤: <br/>
1、用户可以选择用相机拍照或从相册选择一张照片（称源图片）；<br/>
2、压缩源图片（如:10Mb）成一张较小的文件（如:100Kb）（称压缩图片)；<br/>
3、将源图片保存到本地IPFS得到一个HashA, 将压缩图片保存到本地IPFS得到一个HashB；<br/> 
4、将得到的HashA、HashB、源图片的类型和大小、压缩图片的类型和大小一同保存到IPFS得到HashC；<br/>
5、把HashC放到信息交易中到交易池等待矿工打包上链。

注：

- 矿工在打包时，用HashC获取到相关信息后，无需获取HashA内容验证，仅需要验证获取HashB内容验证即可；
- 图片的参数限制：文件大小最高为100Kb, 尺寸大小限制为1200px * 1200px;
- 图片处理的逻辑如下：
   - 图片文件大小小于等于100Kb, 直接跳过；
   - 文件大小大于100Kb, 宽和高都小于等于1200px；则直接进行质量压缩90%，直到文件大小小于等于100Kb;
   - 文件大小大于100Kb, 宽和高有一方大于1200px；则按原尺寸比例进行缩放到都小于等于1200px；则直接进行质量压缩90%，直到文件大小小于等于100Kb; 缩放规则如下：
      - 原尺寸大小宽为X, 高为Y，缩放后的宽为NX, 高为NY；
      - 如果X >= Y, 则NX = 1200；NY = Y / X * NX;
      - 如果X < Y, 则NY = 1200；NX = X / Y * NY;

### 音频

Audio的类型有mp3、amr、aac、war、flac、lamr等：默认格式为mp3。<br/>
用户选择音频媒体逻辑步骤: <br/>
1、用户可以选择录音或从文件系统中选择1个音频文件（称源音频）；<br/>
2、压缩源音频（如:15Mb）成一张较小的文件（如:2Mb）（称压缩音频)；<br/>
3、将源音频保存到本地IPFS得到一个HashA, 将压缩音频保存到本地IPFS得到一个HashB；<br/> 
4、将得到的HashA、HashB、源音频的类型和大小以及时长、压缩音频的类型和大小以及时长一同保存到IPFS得到HashC；<br/>
5、把HashC放到信息交易中到交易池等待矿工打包上链；

注：

- 矿工在打包时，用HashC获取到相关信息后，无需获取HashA内容验证，仅需要验证获取HashB内容验证即可;
- 音频的参数限制：文件大小最高为2Mb, 时长限制为15分钟;
- 音频处理的逻辑如下：
   - 音频文件大小小于等于2Mb, 直接跳过；
   - 文件大小大于2Mb, 时长小于等于15分钟；则直接按照AM的采样率11.025KHz，进行压缩;
   - 文件大小大于2Mb, 时长大于15分钟；则直接截取前15分钟的时长音频，然后再按照AM的采样率11.025KHz，进行压缩;

### 视频

Video的类型有mp4、avi、3gpp、3gp、mov等：默认格式为mp4。</br>
用户选择视频媒体逻辑步骤: <br/>
1、用户可以选择相机录像或从相册中选择一视频文件（称源视频）；<br/>
2、将源视频通过工具或算法截取9成图片和1个音频文件；<br/>
3、将视频保存到本地IPFS得到一个HashA, 将9张图片保存到本地IPFS得到一个HashB1 HashB2...HashB9；将音频文件保存到本地IPFS得到一个HashB10<br/> 
4、将得到的HashA、HashB1 HashB2...HashB10、以及它们的大小、类型和时长一同保存到IPFS得到HashC；<br/>
5、把HashC放到信息交易中到交易池等待矿工打包上链；

注：

- 矿工在打包时，用HashC获取到相关信息后，无需获取HashA内容验证，需要验证获取HashB1 HashB2...HashB10内容验证。
- 视频中的图片和音频则直接按照上面的方案处理。